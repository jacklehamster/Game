<head>
    <title>Three.js</title>
    <meta name="google" value="notranslate"/>
    <meta charset="UTF-8"/>
    <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no,width=device-width, initial-scale=1.0,minimum-scale=1.0"/>
    <meta name="theme-color" content="#d5f97a" />
	<script>
   if(location.pathname.charAt(location.pathname.length-1)!="/") {
//        location.replace(location.pathname+"/"+location.search+location.hash);
		window.history.pushState(null,"", location.pathname+"/"+location.search+location.hash);
   }
	</script>

	
	
    <script language="JavaScript" src="../lib/threejs/three.js"></script>
    <!--script language="JavaScript" src="/lib/dobuki/setup.js"></script-->
    <style>
html, body {
  overflow-x: hidden; overflow-y: auto;
  margin: 0px;
  padding: 0px;
  background-color: black;
}
body {
  position: fixed;
left: 0;pa
    top: 0;
    right: 0;
    bottom: 0;
}

*.unselectable {
   -moz-user-select: -moz-none;
   -khtml-user-select: none;
   -webkit-user-select: none;
   -ms-user-select: none;
   user-select: none;
}
</style>

    <script id="vs" type="x-shader/x-vertex">
        varying vec2 vUv;
        attribute float frame;
        varying float vFrame;
        void main()
        {
            vFrame = frame;
            vUv = uv;
            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0 );
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>
    <script id="fs" type="x-shader/x-fragment">
uniform float iGlobalTime;
uniform sampler2D iChannel0;
uniform sampler2D iTest[ 2 ];

varying vec2 vUv;
varying float vFrame;


void main() {
    vec2 uv = vUv;
    uv.x += iGlobalTime;
    uv.y = uv.y +vFrame;// iGlobalTime + vFrame;
    //uv.y/=2;
    if (uv.y > 2.)
        uv.y = uv.y - 2.;
    gl_FragColor = texture2D( iTest[0],  vec2(uv.x/2.0, uv.y/2.0));
}
</script>
</head>

<body>

    <script>

       document.addEventListener("DOMContentLoaded", initialize);
       function initialize() {
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            var texture = new THREE.TextureLoader().load( "squid.png" );
//            var texture = new THREE.ImageUtils.loadTexture( "boy-walk-down.png" );
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(.5,.5);// 4, 4 );
//            texture.repeat.set(1,1);// 4, 4 );

texture.magFilter = THREE.NearestFilter;
texture.minFilter = THREE.LinearMipMapLinearFilter;

//               texture.offset.x = 10;
//               texture.offset.y = 10;
window.texture = texture;


_uniforms = {
    iGlobalTime:    { type: 'f', value: 0.1 },
    iChannel0:  { type: 't', value: THREE.ImageUtils.loadTexture( 'boy-walk-down.png') },
    iTest:  { type: 'tv', value:
        [THREE.ImageUtils.loadTexture( 'boy-walk-up.png'),
        texture
         ]},
};




var newMaterial = new THREE.ShaderMaterial( {
        uniforms: _uniforms,
        vertexShader: document.getElementById( 'vs' ).textContent,
        fragmentShader: document.getElementById( 'fs' ).textContent,
        transparent:true,
} );


            var material = new THREE.MeshBasicMaterial({map: texture, transparent:true});

            var geometry = new THREE.BoxGeometry( 1, 1, 1 );
//            var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            var cube = new THREE.Mesh( geometry, material );
            scene.add( cube );




            var cube2 = new THREE.Mesh( geometry, material );
//            scene.add( cube2 );
            cube.position.z = -7;

            var geometry3 = new THREE.PlaneBufferGeometry( 5, 5 );
            var number = 1;
/*            geometry3.attributes['hello'] = {
                itemSize: 3,
                array: new Float32Array( number * 3 ),
                numItems: number * 3
            }
*/

            var particles = 100000;
            var colors = new Float32Array( particles * 3 );
            var color = new THREE.Color();

			for ( var i = 0, i3 = 0; i < particles; i ++, i3 += 3 ) {

//				positions[ i3 + 0 ] = ( Math.random() * 2 - 1 ) * radius;
//				positions[ i3 + 1 ] = ( Math.random() * 2 - 1 ) * radius;
//				positions[ i3 + 2 ] = ( Math.random() * 2 - 1 ) * radius;

				color.setHSL( i / particles, 1.0, 0.5 );

				colors[ i3 + 0 ] = color.r;
				colors[ i3 + 1 ] = color.g;
				colors[ i3 + 2 ] = color.b;

//				sizes[ i ] = 20;

			}

			var frames = new THREE.BufferAttribute(
                new Float32Array( 1 * particles ), 1);
                frames[0] = 0;

            geometry3.addAttribute( 'frame', frames);

            var material3 = new THREE.MeshBasicMaterial({map: texture, transparent:true});
            material3 = newMaterial;
            var plane = new THREE.Mesh( geometry3, material3 );
//            plane.attributes['hello'] = { type: 'c', value: null };
            window.material3 = material3;

            scene.add( plane );

//            camera.position.z = 5;
            window.plane = plane;
            plane.position.z = -5;
            window.camera = camera;

changed = false;
           function render(time) {
                var count = Math.floor(time/100);

                _uniforms.iGlobalTime.value = time/1000 % 1;
                if (time > 5000 && !changed) {
                    changed = true;
                    _uniforms.iTest.value[0] = new THREE.TextureLoader().load( "boy-walk-down.png",
                        function() {
                            _uniforms.iTest.needsUpdate = true;
                        }
                     );
//                        THREE.ImageUtils.loadTexture( 'boy-walk-down.png');
                }
//                console.log(_uniforms.iTest.value[0]);

               texture.offset.x = .5 * (count%2);
               texture.offset.y = .5 * Math.floor(count/2%2);
//               console.log(texture.offset);


		var frames = geometry3.attributes.frame.array;
//		if(count%10==0) {
            for(var i=0;i<100000; i++) {
                frames[i] = time/10000 % 2;
                //frames[i] = Math.random();
            }
			geometry3.attributes.frame.needsUpdate = true;
//		}


                cube.rotation.x = time/1000;
                cube.rotation.y = time/1000;
                cube.position.z = -5+Math.sin(time/300);
                requestAnimationFrame( render );
                renderer.render( scene, camera );
            }
            render();

            window.addEventListener("resize", resize);
            resize();

           function resize() {
              var scale = window.devicePixelRatio;
    //          var w = window.innerWidth;
    //          var h = window.innerHeight;
              renderer.setSize( window.innerWidth, window.innerHeight );
              camera.aspect = window.innerWidth / window.innerHeight;
              camera.updateProjectionMatrix();
console.log(camera.aspect);
    //          canvas.width = w*scale;
    //          canvas.height = h*scale;
    //          canvas.style.width = w+'px';
    //          canvas.style.height = h+'px';
           }


       }
    </script>


</body>
