{"version":3,"sources":["../../../../lib/jsgif/O/h.orig"],"names":["assert","require","sum","a","reduce","x","y","bitsToNum","ba","s","n","Array","prototype","shiftN","undefined","shift","splice","byteToBitArr","byte","i","push","Stream","data","len","length","pos","read","Error","substring","readToEnd","readToNull","val","readByte","readBytes","charCodeAt","readUnsigned","parseGIF","gif","log","console","apply","arguments","logWithPrefix","prefix","args","slice","call","str","concat","st","blocks","parseCT","entries","ct","parseHeader","sig","ver","equal","width","height","bits","gctFlag","colorRes","sorted","gctSize","bgColor","pixelAspectRatio","gct","parseExt","block","parseGCExt","blockSize","reserved","disposalMethod","userInput","transparencyGiven","delayTime","transparencyIndex","terminator","parseCommExt","comBlocks","comBlock","size","lzwBlock","lzwBlocks","comBLock","parseAppExt","parseNetscapeExt","unknown","iterations","identifier","authCode","label","extType","toString","parseImg","leftPos","topPos","lctFlag","interlace","lctSize","lct","c","lzwMinCodeSize","parseBlocks","sentinel","String","fromCharCode","type","parse","process","argv","forEach","arg","readFileSync","inspect"],"mappings":"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","file":"h.js","sourcesContent":["\n\nvar assert = require('assert');\n\n// Generic functions\nfunction sum(a) {\n  a.reduce(function(x,y) { return x + y; }, 0);\n}\n\nfunction bitsToNum(ba) {\n  return ba.reduce(function(s, n) { return s * 2 + n; }, 0);\n}\n\nArray.prototype.shiftN = function(n) {\n  if (n == undefined) {\n    return this.shift(); // Will return the element, not a singleton array.\n  } else {\n    return this.splice(0,n);\n  }\n}\n\nfunction byteToBitArr(byte) {\n  var a = [];\n  for (var i = 7; i >= 0; i--) {\n    a.push(!!(byte & (1 << i)));\n  }\n  return a;\n}\n\n// Stream\nvar Stream = function(data) {\n  this.data = data;\n  this.len = this.data.length;\n  this.pos = 0;\n\n  this.read = function(n) {\n    if (this.pos + n > this.data.length)\n      throw new Error(\"Attempted to read past end of stream.\");\n    return this.data.substring(this.pos, this.pos += n);\n  }\n\n  this.readToEnd = function() {\n    return this.read(this.data.length - this.pos);\n  }\n\n  this.readToNull = function() { // Can also use indexOf('\\0')\n    var a = [];\n    var byte;\n    while (val = this.readByte()) {\n      a.push(byte);\n    }\n    a.push(byte); // Sigh...\n    return a;\n  } // Shouldn't use this anyway. Data sub-blocks often have \\0s.\n\n  this.readBytes = function(n) {\n    var s = this.read(n);\n    var a = [];\n    for (var i = 0; i < s.length; i++) {\n      a.push(s.charCodeAt(i));\n    }\n    return a;\n  }\n\n  this.readByte = function() {\n    return this.readBytes(1)[0];\n  }\n\n  this.readUnsigned = function() { // Little-endian.\n    var a = this.readBytes(2);\n    return (a[1] << 8) + a[0];\n  }\n}\n\nvar parseGIF = function(data) {\n  var gif = {};\n\n  var log = function() {\n    //var args = Array.prototype.slice.call(arguments);\n    //var str = args.shift();\n    console.log.apply(this, arguments);\n  }\n\n  function logWithPrefix(prefix) {\n    return function() {\n      var args = Array.prototype.slice.call(arguments);\n      var str = args.shift();\n      console.log.apply(this, [prefix + str].concat(args));\n    }\n  }\n\n  var st = new Stream(data);\n  gif.blocks = [];\n\n  function parseCT(entries) { // Each entry is 3 bytes, for RGB.\n    var ct = [];\n    for (var i = 0; i < entries; i++) {\n      ct.push(st.readBytes(3));\n    }\n    return ct;\n  }\n\n  function parseHeader() {\n    gif.sig = st.read(3);\n    gif.ver = st.read(3);\n    assert.equal(gif.sig, 'GIF');\n    log('sig: %s, ver: %s', gif.sig, gif.ver);\n\n    gif.width = st.readUnsigned();\n    gif.height = st.readUnsigned();\n    log(\"w×h: %d×%d\", gif.width, gif.height);\n\n    var bits = byteToBitArr(st.readByte());\n    gif.gctFlag = bits.shift();\n    gif.colorRes = bitsToNum(bits.shiftN(3));\n    gif.sorted = bits.shift();\n    gif.gctSize = bitsToNum(bits.shiftN(3));\n    log(\"gct? %d, colorRes: %d, sorted? %d, gctSize: %d\",\n          gif.gctFlag, gif.colorRes, gif.sorted, gif.gctSize);\n\n    gif.bgColor = st.readByte();\n    gif.pixelAspectRatio = st.readByte(); // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\n    log('bgColor: %d, pixelAspectRatio: %d', gif.bgColor, gif.pixelAspectRatio);\n\n    if (gif.gctFlag) {\n      gif.gct = parseCT(1 << (gif.gctSize + 1));\n      log('gct read; %d entries', gif.gct.length);\n    }\n  }\n\n  function parseExt(block) {\n    var log = logWithPrefix('  ');\n\n    function parseGCExt(block) {\n      var blockSize = st.readByte();\n      log('blockSize: %d', blockSize);\n\n      var bits = byteToBitArr(st.readByte());\n      block.reserved = bits.shiftN(3); // Reserved; should be 000.\n      block.disposalMethod = bitsToNum(bits.shiftN(3));\n      block.userInput = bits.shift();\n      block.transparencyGiven = bits.shift();\n      log('reserved: %d, disposalMethod: %d, userInput: %d, transparencyGiven: %d',\n             block.reserved, block.disposalMethod, block.userInput, block.transparencyGiven);\n\n      block.delayTime = st.readUnsigned();\n      log('delayTime: %d', block.delayTime);\n\n      //if (block.transparencyGiven) { // TODO verify this needs to be an if\n        var transparencyIndex = st.readByte();\n        log('transparencyIndex: %d', transparencyIndex);\n      //}\n      block.terminator = st.readByte();\n      log('terminator: %d', block.terminator);\n    }\n\n    function parseCommExt(block) {\n      block.comBlocks = [];\n      while (true) {\n        var comBlock = {};\n        comBlock.size = st.readByte();\n        lzwBlock.data = st.read(comBlock.size);\n        block.lzwBlocks.push(comBLock);\n        if (comBlock.size == 0) return;\n      }\n    }\n\n    function parseAppExt(block) {\n      function parseNetscapeExt(block) {\n        var blockSize = st.readByte(); // Always 3\n        block.unknown = st.readByte() // ??? Always 1? What is this?\n        block.iterations = st.readUnsigned();\n        block.terminator = st.readByte();\n        log('iterations: %d, terminator: %d', block.iterations, block.terminator);\n      }\n      var blockSize = st.readByte(); // Always 11\n      block.identifier = st.read(8);\n      block.authCode = st.read(3);\n      log('identifier: %s, authCode: %s', block.identifier, block.authCode);\n      switch (block.identifier + block.authCode) {\n        case 'NETSCAPE2.0':\n          log('NETSCAPE');\n          parseNetscapeExt(block);\n          break;\n        default:\n          throw new Error(\"Unknown Application Extension: \" + block.identifier);\n          break;\n      }\n    }\n\n    block.label = st.readByte();\n    switch (block.label) {\n      case 0xF9:\n        block.extType = 'gce';\n        log('Graphics Control Extension');\n        parseGCExt(block);\n        break;\n      case 0xFE:\n        block.extType = 'com';\n        log('Comment Extension')\n          parseCommExt(block);\n        break;\n      case 0xFF:\n        block.extType = 'app';\n        log('Application Extension');\n        parseAppExt(block);\n        break;\n      case 0x01:\n        throw new Error(\"Plain Text extension (0x01) unsupported\")\n        break;\n      default:\n        throw new Error(\"Unknown extension: 0x\" + label.toString(16));\n        break;\n    }\n  }\n\n  function parseImg(block) {\n    var log = logWithPrefix('  ');\n\n    block.leftPos = st.readUnsigned();\n    block.topPos = st.readUnsigned();\n    block.width = st.readUnsigned();\n    block.height = st.readUnsigned();\n    log('left: %d, top: %d, width: %d, height: %d',\n          block.leftPos, block.topPos, block.width, block.height);\n\n    var bits = byteToBitArr(st.readByte());\n    block.lctFlag = bits.shift();\n    block.interlace = bits.shift();\n    block.sorted = bits.shift();\n    block.reserved = bits.shiftN(2);\n    block.lctSize = bits.shiftN(3);\n    log('lct? %d, interlace? %d, sorted? %d, reserved: %d, lctSize: %d',\n          block.lctFlag, block.interlace, block.sorted, block.reserved, block.lctSize);\n\n    if (block.lctFlag) {\n      block.lct = parseCT(1 << (block.lctSize + 1));\n      log('lct read; %d entries', block.lct.length);\n    }\n\n    block.data = st.readToNull();\n    c(block.data);\n    return;\n    block.lzwMinCodeSize = st.readByte();\n    block.lzwBlocks = [];\n    while (true) {\n      var lzwBlock = {};\n      lzwBlock.size = st.readByte();\n      lzwBlock.data = st.read(lzwBlock.size);\n      block.lzwBlocks.push(lzwBlock);\n      if (lzwBlock.size == 0) return;\n    }\n  }\n\n  function parseBlocks() {\n    while (true) {\n      var block = {};\n      block.sentinel = st.readByte();\n      switch (String.fromCharCode(block.sentinel)) { // For ease of matching\n        case '!':\n          block.type = 'ext';\n          log('Extension block:');\n          parseExt(block);\n          break;\n        case ',':\n          log('Image block:');\n          block.type = 'img';\n          parseImg(block);\n          break;\n        case ';':\n          block.type = 'trailer';\n          log('Trailer (;) reached!');\n          return;\n          break; //\n        default:\n          throw new Error(\"Unknown block: 0x\" + block.sentinel.toString(16));\n      }\n      gif.blocks.push(block);\n    }\n  }\n\n  function parse() {\n    parseHeader();\n    parseBlocks();\n  }\n\n  parse();\n  return gif;\n}\n\n\n// runish\n\n//var tiny_gif = \"GIF89a\\x01\\x00\\x01\\x00\\x80\\x00\\x00\\xFF\\xFF\\xFF\\x00\\x00\\x00!\\xF9\\x04\\x01\\x00\\x00\\x00\\x00,\\x00\\x00\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x02\\x02D\\x01\\x00;\";\n//var wiki_gif = fs.readFileSync('GifSample.gif').toString();\n\n\nc = console.log;\n\n\nprocess.argv.forEach(function (arg, i) { // Not an array?!\n  if (i > 1) {\n    c('%s', arg);\n    c('%s', (function (n) { var s = ''; for (var i = 0; i < n; i++) { s += '-'; }; return s; })(arg.length));\n    var data = require('fs').readFileSync(arg).toString('binary');\n    var gif = parseGIF(data);\n    console.log('%s', require('sys').inspect(gif));\n  }\n})\n\n//doGif('tiny.gif');\n//doGif('wiki.gif');\n//doGif('bouncing_ball.gif');\n"]}