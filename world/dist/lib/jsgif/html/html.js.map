{"version":3,"sources":["../../../../lib/jsgif/html/html.js"],"names":["bookmarklet","playGIF","gif","stream","hdr","loadError","transparency","delay","disposalMethod","lastDisposalMethod","frame","playing","forward","frames","clear","doParse","parseGIF","handler","err","doLoadError","doGet","h","XMLHttpRequest","overrideMimeType","onload","e","Stream","responseText","setTimeout","onprogress","doLoadProgress","onerror","open","src","send","doText","text","toolbar","innerHTML","doShowProgress","prefix","pos","length","draw","style","visibility","height","Math","min","canvas","top","bottom","mid","width","ctx","fillStyle","fillRect","floor","lengthComputable","loaded","total","originOfError","drawError","strokeStyle","lineWidth","moveTo","lineTo","stroke","doPlay","doHdr","_hdr","div","minWidth","tmpCanvas","doGCE","gce","pushFrame","transparencyGiven","transparencyIndex","delayTime","push","data","getImageData","doImg","img","getContext","ct","lctFlag","lct","gct","cData","leftPos","topPos","pixels","forEach","pixel","i","putImageData","curFrame","delayInfo","showingInfo","pinned","stepFrame","delta","value","putFrame","step","stepping","doStep","initToolbar","right","left","bar","rarr","larr","xsign","circle","circledot","nearr","playIcon","pauseIcon","revplayIcon","prevIcon","nextIcon","showInfoIcon","revIcon","revrevIcon","closeIcon","pinIcon","unpinIcon","popupIcon","elt","tag","cls","attrs","document","createElement","className","k","simpleTools","rev","showInfo","prev","playPause","next","pin","close","infoTools","type","updateTools","title","display","disabled","t","createTextNode","appendChild","popup","addEventListener","window","populate","children","c","simpleToolList","doRev","focus","doNextFrame","doPrevFrame","doPlayPause","doCurFrameChanged","newFrame","isNaN","doCurDelayChanged","newDelay","doToggleShowingInfo","doTogglePinned","doClose","preventDefault","parent","insertBefore","removeChild","doDecodeProgress","doNothing","withProgress","fn","block","com","app","NETSCAPE","eof","parentNode","bookmarkletCSS","insertCSS","css","textContent","body","to_a","pseudoList","a","join","strings","between","undefined","reduce","s","n","elemClasses","elem","split","addClass","removeClass","classes","filter","_cls","imgs","getElementsByTagName","gifs","slice","toLowerCase","clicked","rmOverlay","mkOverlay","indexOf","removeEventListener"],"mappings":"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","file":"html.js","sourcesContent":["//var bookmarklet = function() {\nvar bookmarklet = function() {\n\n // INSERT_GIF_JS_HERE\n\n  var playGIF = function(gif) {\n    var stream;\n    var hdr;\n\n    var loadError = null;\n\n    var transparency = null;\n    var delay = null;\n    var disposalMethod = null;\n    var lastDisposalMethod = null;\n    var frame = null;\n\n    var playing = true;\n    var forward = true;\n\n    var frames = [];\n\n    var clear = function() {\n      transparency = null;\n      delay = null;\n      lastDisposalMethod = disposalMethod;\n      disposalMethod = null;\n      frame = null;\n      //frame = tmpCanvas.getContext('2d');\n    };\n\n    // XXX: There's probably a better way to handle catching exceptions when\n    // callbacks are involved.\n    var doParse = function() {\n        try {\n          parseGIF(stream, handler);\n        } catch(err) {\n          doLoadError('parse');\n        }\n    };\n\n    var doGet = function() {\n      var h = new XMLHttpRequest();\n      h.overrideMimeType('text/plain; charset=x-user-defined');\n      h.onload = function(e) {\n        //doLoadProgress(e);\n        // TODO: In IE, might be able to use h.responseBody instead of overrideMimeType.\n        stream = new Stream(h.responseText);\n        setTimeout(doParse, 0);\n      };\n      h.onprogress = doLoadProgress;\n      h.onerror = function() { doLoadError('xhr'); };\n      h.open('GET', gif.src, true);\n      h.send();\n    };\n\n    var doText = function(text) {\n      toolbar.innerHTML = text; // innerText? Escaping? Whatever.\n      //ctx.fillStyle = 'black';\n      //ctx.font = '32px sans-serif';\n      //ctx.fillText(text, 8, 32);\n    };\n\n    var doShowProgress = function(prefix, pos, length, draw) {\n      //toolbar.style.display = pos === length ? 'none' : 'block';\n      //toolbar.style.display = pos === length ? '' : 'block'; // FIXME Move this to doPlay() or something.\n      toolbar.style.visibility = pos === length ? '' : 'visible'; // FIXME Move this to doPlay() or something.\n\n      if (draw) {\n        var height = Math.min(canvas.height >> 3, canvas.height);\n        var top = (canvas.height - height) >> 1;\n        var bottom = (canvas.height + height) >> 1;\n        var mid = (pos / length) * canvas.width;\n\n        // XXX Figure out alpha fillRect.\n        //ctx.fillStyle = 'salmon';\n        ctx.fillStyle = 'rgba(255,160,122,0.5)';\n        ctx.fillRect(mid, top, canvas.width - mid, height);\n\n        //ctx.fillStyle = 'teal';\n        ctx.fillStyle = 'rgba(0,128,128,0.5)';\n        ctx.fillRect(0, top, (pos / length) * canvas.width, height);\n      }\n\n      doText(prefix + ' ' + Math.floor(pos / length * 100) + '%');\n    };\n\n    var doLoadProgress = function(e) {\n      // TODO: Find out what lengthComputable actually means.\n      if (e.lengthComputable) doShowProgress('Loading...', e.loaded, e.total, true);\n    };\n\n    var doLoadError = function(originOfError) {\n      var drawError = function() {\n        ctx.fillStyle = 'black';\n        ctx.fillRect(0, 0, hdr.width, hdr.height);\n        ctx.strokeStyle = 'red';\n        ctx.lineWidth = 3;\n        ctx.moveTo(0, 0);\n        ctx.lineTo(hdr.width, hdr.height);\n        ctx.moveTo(0, hdr.height);\n        ctx.lineTo(hdr.width, 0);\n        ctx.stroke();\n      };\n\n      loadError = originOfError;\n      hdr = {width: gif.width, height: gif.height}; // Fake header.\n      frames = [];\n      drawError();\n      setTimeout(doPlay, 0);\n    };\n\n    var doHdr = function(_hdr) {\n      hdr = _hdr;\n      //console.assert(gif.width === hdr.width && gif.height === hdr.height); // See other TODO.\n\n      canvas.width = hdr.width;\n      canvas.height = hdr.height;\n      div.style.width = hdr.width + 'px';\n      //div.style.height = hdr.height + 'px';\n      toolbar.style.minWidth = hdr.width + 'px';\n\n      tmpCanvas.width = hdr.width;\n      tmpCanvas.height = hdr.height;\n      //if (hdr.gctFlag) { // Fill background.\n      //  rgb = hdr.gct[hdr.bgColor];\n      //  tmpCanvas.fillStyle = 'rgba(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ',');\n      //}\n      //tmpCanvas.getContext('2d').fillRect(0, 0, hdr.width, hdr.height);\n      // TODO: Figure out the disposal method business.\n    };\n\n    var doGCE = function(gce) {\n      pushFrame();\n      clear();\n      transparency = gce.transparencyGiven ? gce.transparencyIndex : null;\n      delay = gce.delayTime;\n      disposalMethod = gce.disposalMethod;\n      // We don't have much to do with the rest of GCE.\n    };\n\n    var pushFrame = function() {\n      if (!frame) return;\n      frames.push({data: frame.getImageData(0, 0, hdr.width, hdr.height),\n                   delay: delay});\n    };\n\n    var doImg = function(img) {\n      if (!frame) frame = tmpCanvas.getContext('2d');\n      var ct = img.lctFlag ? img.lct : hdr.gct; // TODO: What if neither exists?\n\n      var cData = frame.getImageData(img.leftPos, img.topPos, img.width, img.height);\n\n      img.pixels.forEach(function(pixel, i) {\n        // cData.data === [R,G,B,A,...]\n        if (transparency !== pixel) { // This includes null, if no transparency was defined.\n          cData.data[i * 4 + 0] = ct[pixel][0];\n          cData.data[i * 4 + 1] = ct[pixel][1];\n          cData.data[i * 4 + 2] = ct[pixel][2];\n          cData.data[i * 4 + 3] = 255; // Opaque.\n        } else {\n          // TODO: Handle disposal method properly.\n          // XXX: When I get to an Internet connection, check which disposal method is which.\n          if (lastDisposalMethod === 2 || lastDisposalMethod === 3) {\n            cData.data[i * 4 + 3] = 0; // Transparent.\n            // XXX: This is very very wrong.\n          } else {\n            // lastDisposalMethod should be null (no GCE), 0, or 1; leave the pixel as it is.\n            // assert(lastDispsalMethod === null || lastDispsalMethod === 0 || lastDispsalMethod === 1);\n            // XXX: If this is the first frame (and we *do* have a GCE),\n            // lastDispsalMethod will be null, but we want to set undefined\n            // pixels to the background color.\n          }\n        }\n      });\n      frame.putImageData(cData, img.leftPos, img.topPos);\n      // We could use the on-page canvas directly, except that we draw a progress\n      // bar for each image chunk (not just the final image).\n      ctx.putImageData(cData, img.leftPos, img.topPos);\n    };\n\n    var doPlay = (function() {\n        var i = -1;\n        var curFrame;  // XXX These two are <input> tags. They're declared up here\n                       // instead of in initToolbar's scope so that stepFrame has\n                       // access to them. This is hacky and should be eliminated.\n                       // (Maybe this should actually be a class instead of a\n                       // cheap plastic imitation? At the very least it should be\n                       // abstracted more.)\n        var delayInfo;\n\n\n        var showingInfo = false;\n        var pinned = false;\n\n        var stepFrame = function(delta) { // XXX: Name is confusing.\n          i = (i + delta + frames.length) % frames.length;\n          curFrame.value = i + 1;\n          delayInfo.value = frames[i].delay;\n          putFrame();\n        };\n\n        var step = (function() {\n          var stepping = false;\n\n          var doStep = function() {\n            stepping = playing;\n            if (!stepping) return;\n\n            stepFrame(forward ? 1 : -1);\n            var delay = frames[i].delay * 10;\n            if (!delay) delay = 100; // FIXME: Should this even default at all? What should it be?\n            setTimeout(doStep, delay);\n          };\n\n          return function() { if (!stepping) setTimeout(doStep, 0); };\n        }());\n\n        var putFrame = function() {\n          ctx.putImageData(frames[i].data, 0, 0);\n        };\n\n        var initToolbar = function() {\n          // Characters.\n          var right = '&#9654;';\n          var left = '&#9664;';\n          var bar = '&#10073;';\n          var rarr = '&rarr;';\n          var larr = '&larr;';\n          var xsign = '&#10006;';\n          //var infosource = '&#8505;';\n          var circle = '&#9675;';\n          var circledot = '&#8857;';\n          //var blackSquare = '&#9632;'; // XXX\n          //var doubleVerticalLine = '&#8214;'; // XXX\n          var nearr = '&nearr;';\n          // Buttons.\n          var playIcon = right;\n          var pauseIcon = bar + bar;\n          var revplayIcon = left;\n          var prevIcon = left + bar;\n          var nextIcon = bar + right;\n          //var showInfoIcon = infosource;\n          var showInfoIcon = 'i'; // Fonts.\n          var revIcon = larr;\n          var revrevIcon = rarr;\n          var closeIcon = xsign;\n          var pinIcon = circledot;\n          var unpinIcon = circle;\n          var popupIcon = nearr;\n\n          /**\n           * @param{Object=} attrs Attributes (optional).\n           */ // Make compiler happy.\n          var elt = function(tag, cls, attrs) {\n            var e = document.createElement(tag);\n            if (cls) e.className = 'jsgif_' + cls;\n            for (var k in attrs) {\n              e[k] = attrs[k];\n            }\n            return e;\n          };\n\n          var simpleTools = elt('div', 'simple_tools');\n          var rev = elt('button', 'rev');\n          var showInfo = elt('button', 'show_info');\n          var prev = elt('button', 'prev');\n          var playPause = elt('button', 'play_pause');\n          var next = elt('button', 'next');\n          var pin = elt('button', 'pin');\n          var close = elt('button', 'close');\n\n          var infoTools = elt('div', 'info_tools');\n          curFrame = elt('input', 'cur_frame', {type: 'text'}); // See above.\n          delayInfo = elt('input', 'delay_info', {type: 'text'}); // See above.\n\n          var updateTools = function() {\n            if (playing) {\n              playPause.innerHTML = pauseIcon;\n                playPause.title = 'Pause'\n              prev.style.visibility = 'hidden'; // See TODO.\n              next.style.visibility = 'hidden';\n            } else {\n              playPause.innerHTML = forward ? playIcon : revplayIcon;\n                playPause.title = 'Play';\n              prev.style.visibility = '';\n              next.style.visibility = '';\n            }\n\n            toolbar.style.visibility = pinned ? 'visible' : ''; // See TODO.\n\n            infoTools.style.display = showingInfo ? '' : 'none'; // See TODO.\n\n            showInfo.innerHTML = showInfoIcon;\n              showInfo.title = 'Show info/more tools'\n            rev.innerHTML = forward ? revIcon : revrevIcon;\n              rev.title = forward ? 'Reverse' : 'Un-reverse';\n            prev.innerHTML = prevIcon;\n              prev.title = 'Previous frame';\n            next.innerHTML = nextIcon;\n              next.title = 'Next frame'\n            pin.innerHTML = pinned ? unpinIcon : pinIcon;\n              pin.title = pinned ? 'Unpin' : 'Pin';\n            close.innerHTML = closeIcon;\n              close.title = 'Close jsgif and go back to original image';\n\n            curFrame.disabled = playing;\n            delayInfo.disabled = playing;\n\n            toolbar.innerHTML = '';\n            simpleTools.innerHTML = '';\n            infoTools.innerHTML = '';\n\n            var t = function(text) { return document.createTextNode(text); };\n\n            if (frames.length < 2) { // XXX\n              // Also, this shouldn't actually be playing in this case.\n              // TODO: Are we going to want an info tool that'll be displayed on static GIFs later?\n\n              if (loadError == 'xhr') {\n                toolbar.appendChild(t(\"Load failed; cross-domain? \"));\n\n                var popup = elt('button', 'popup');\n                popup.addEventListener('click', function() { window.open(gif.src); } );\n                popup.innerHTML = popupIcon;\n                  popup.title = 'Click to open GIF in new window; try running jsgif there instead';\n                toolbar.appendChild(popup);\n              } else if (loadError == 'parse') {\n                toolbar.appendChild(t(\"Parse failed \"));\n              }\n\n              toolbar.appendChild(close);\n\n              return;\n            }\n\n            // We don't actually need to repack all of these -- that's left over\n            // from before -- but it doesn't especially hurt either.\n            var populate = function(elt, children) {\n              elt.innerHTML = '';\n              children.forEach(function(c) { elt.appendChild(c); });\n              //children.forEach(elt.appendChild); // Is this a \"pseudo-function\"?\n            };\n\n            // XXX Blach.\n            var simpleToolList = forward ? [showInfo, rev, prev, playPause, next, pin, close]\n                                         : [showInfo, rev, next, playPause, prev, pin, close];\n            populate(toolbar, [simpleTools, infoTools]);\n            populate(simpleTools, simpleToolList);\n            populate(infoTools, [t(' frame: '), curFrame, t(' / '), t(frames.length), t(' (delay: '), delayInfo, t(')')]);\n          };\n\n          var doRev = function() {\n            forward = !forward;\n            updateTools();\n            rev.focus(); // (because repack)\n          };\n\n          var doNextFrame = function() { stepFrame(1); };\n          var doPrevFrame = function() { stepFrame(-1); };\n\n          var doPlayPause = function() {\n            playing = !playing;\n            updateTools();\n            playPause.focus(); // In case this was called by clicking on the\n                               // canvas (we have to do this here because we\n                               // repack the buttons).\n            step();\n          };\n\n          var doCurFrameChanged = function() {\n            var newFrame = +curFrame.value;\n            if (isNaN(newFrame) || newFrame < 1 || newFrame > frames.length) {\n              // Invalid frame; put it back to what it was.\n              curFrame.value = i + 1;\n            } else {\n              i = newFrame - 1;\n              putFrame();\n            }\n          };\n\n          var doCurDelayChanged = function() {\n            var newDelay = +delayInfo.value;\n            if (!isNaN(newDelay)) {\n              frames[i].delay = newDelay;\n            }\n          };\n\n          var doToggleShowingInfo = function() {\n            showingInfo = !showingInfo;\n            updateTools();\n            showInfo.focus(); // (because repack)\n          };\n\n          var doTogglePinned = function() {\n            pinned = !pinned;\n            updateTools();\n            pin.focus(); // (because repack)\n          };\n\n          // TODO: If the <img> was in an <a>, every one of these will go to the\n          // URL. We don't want that for the buttons (and probably not for\n          // anything?).\n          showInfo.addEventListener('click', doToggleShowingInfo, false);\n          rev.addEventListener('click', doRev, false);\n          curFrame.addEventListener('change', doCurFrameChanged, false);\n          prev.addEventListener('click', doPrevFrame, false);\n          playPause.addEventListener('click', doPlayPause, false);\n          next.addEventListener('click', doNextFrame, false);\n          pin.addEventListener('click', doTogglePinned, false);\n          close.addEventListener('click', doClose, false);\n\n          delayInfo.addEventListener('change', doCurDelayChanged, false);\n\n          canvas.addEventListener('click', doPlayPause, false);\n\n          // For now, to handle GIFs in <a> tags and so on. This needs to be handled better, though.\n          div.addEventListener('click', function(e) { e.preventDefault(); }, false);\n\n          updateTools();\n        };\n\n        return function() {\n          setTimeout(initToolbar, 0);\n          if (loadError) return;\n          canvas.width = hdr.width;\n          canvas.height = hdr.height;\n          step();\n        };\n    }());\n\n    var doClose = function() {\n      playing = false;\n      parent.insertBefore(gif, div);\n      parent.removeChild(div);\n    };\n\n    var doDecodeProgress = function(draw) {\n      doShowProgress('Decoding (frame ' + (frames.length + 1) + ')...', stream.pos, stream.data.length, draw);\n    };\n\n    var doNothing = function(){};\n    /**\n     * @param{boolean=} draw Whether to draw progress bar or not; this is not idempotent because of translucency.\n     *                       Note that this means that the text will be unsynchronized with the progress bar on non-frames;\n     *                       but those are typically so small (GCE etc.) that it doesn't really matter. TODO: Do this properly.\n     */\n    var withProgress = function(fn, draw) {\n      return function(block) {\n        fn(block);\n        doDecodeProgress(draw);\n      };\n    };\n\n\n    var handler = {\n      hdr: withProgress(doHdr),\n      gce: withProgress(doGCE),\n      com: withProgress(doNothing), // I guess that's all for now.\n      app: {\n       // TODO: Is there much point in actually supporting iterations?\n        NETSCAPE: withProgress(doNothing)\n      },\n      img: withProgress(doImg, true),\n      eof: function(block) {\n        //toolbar.style.display = '';\n        pushFrame();\n        doDecodeProgress(false);\n        doText('Playing...');\n        doPlay();\n      }\n    };\n\n    var parent = gif.parentNode;\n\n    var div = document.createElement('div');\n    var canvas = document.createElement('canvas');\n    var ctx = canvas.getContext('2d');\n    var toolbar = document.createElement('div');\n\n    var tmpCanvas = document.createElement('canvas');\n\n    // Copy the computed style of the <img> to the <div>. The CSS specifies\n    // !important for all its properties; this still has a few issues, but it's\n    // probably preferable to not doing it. XXX: Maybe this should only copy a\n    // few specific properties (or specify properties more thoroughly in the\n    // CSS)?\n    // (If we don't hav getComputedStyle we'll have to get along without it, of\n    // course. It's not as if this supports IE, anyway, though, so I don't know\n    // if that really matters.)\n    //\n    // XXX: Commented out for now. If uncommenting, make sure to add !important\n    // to all the CSS properties in jsgif.css\n    //\n    //if (window.getComputedStyle) {\n    //  for (var s in window.getComputedStyle(gif)) {\n    //    div.style[s] = gif.style[s];\n    //  }\n    //}\n\n    // This is our first estimate for the size of the picture. It might have been\n    // changed so we'll correct it when we parse the header. TODO: Handle zoom etc.\n    canvas.width = gif.width;\n    canvas.height = gif.height;\n    toolbar.style.minWidth = gif.width + 'px';\n\n    div.className = 'jsgif';\n    toolbar.className = 'jsgif_toolbar';\n    div.appendChild(canvas);\n    div.appendChild(toolbar);\n\n    parent.insertBefore(div, gif);\n    parent.removeChild(gif);\n\n    doText('Loading...');\n    doGet();\n  };\n\n  var bookmarkletCSS = '/* INSERT_CSS_HERE */';\n\n  var insertCSS = function(css) { // Surely there's a much better way of handling this whole thing.\n    // XXX: If there isn't a better way of handling this: Should we remove the <style> tag when the bookmarklet is done?\n    var style = document.createElement('style');\n    style.type = 'text/css';\n    style.textContent = css; // See TODO.\n    document.body.appendChild(style);\n  };\n\n  var to_a = function(pseudoList) { // Blagh, delicious DOM. I'll do this for now.\n    var a = [];\n    for (var i = 0; i < pseudoList.length; i++) {\n      a.push(pseudoList[i]);\n    }\n    return a;\n  };\n\n  // There *has* to be a better way of doing this. This is just... Temporary. That's right, temporary.\n  var join = function(strings, between) {\n    if (between === undefined) between = '';\n    return strings.reduce(function(s, n) { return s + between + n; }, '');\n  };\n  var elemClasses = function(elem) {\n    return elem.className.split(/\\s/);\n  };\n  var addClass = function(elem, cls) {\n    elem.className += ' ' + cls;\n  };\n  var removeClass = function(elem, cls) {\n    var classes = elemClasses(elem).filter(function(_cls) { return _cls !== cls; });\n    elem.className = join(classes, ' ');\n  };\n\n  var imgs = to_a(document.getElementsByTagName('img'));\n  var gifs = imgs.filter(function(img) {\n    return img.src.slice(-4).toLowerCase() === '.gif';\n    // This is a very cheap plastic imitation of checking the MIME type -- I've\n    // seen GIFs with no extension (or, even worse, ending in .jpg). I can't\n    // see a good way of figuring out if an image is a GIF, though, so this\n    // will have TODO for now.\n  });\n  // Partial workaround: If there were no .gif images, we'll just try all the <img> tags.\n  if (gifs.length === 0) gifs = imgs;\n\n  var clicked = function(e) {\n    var gif = this; // eventListener context\n    gifs.forEach(rmOverlay);\n    setTimeout(function() { playGIF(gif); }, 0);\n    e.preventDefault();\n  };\n\n  var mkOverlay = function(gif) {\n    if (elemClasses(gif).indexOf('jsgif_overlaid') !== -1) return; // Idempotent.\n    addClass(gif, 'jsgif_overlaid');\n    gif.addEventListener('click', clicked, false);\n  };\n\n  var rmOverlay = function(gif) {\n    // XXX: What if the bookmarklet was run more than once?\n    removeClass(gif, 'jsgif_overlaid');\n    gif.removeEventListener('click', clicked, false);\n  };\n\n  //var clicked = function() {\n  //  var gif = overlay_to_gif(this);\n  //  gifs.forEach(rmOverlay);\n  //  setTimeout(function() { playGIF(gif); }, 0);\n  //};\n\n  //var mkOverlay = function(gif) {\n  //  var overlayOuter = document.createElement('div');\n  //  overlayOuter.className = 'jsgif_overlay_outer';\n  //  var overlayInner = document.createElement('div');\n  //  overlayInner.className = 'jsgif_overlay_inner';\n  //  var parent = gif.parentNode;\n  //  parent.insertBefore(overlayOuter, gif);\n  //  parent.removeChild(gif);\n  //  overlayOuter.appendChild(gif);\n  //  overlayOuter.appendChild(overlayInner);\n  //  overlayInner.addEventListener('click', clicked, false);\n  //};\n\n  //var clearOverlay = function(gif) {\n  //  var overlayOuter = gif.parentNode;\n  //  var parent = overlayOuter.parentNode;\n  //  overlayOuter.removeChild(gif);\n  //  parent.insertBefore(gif, overlayOuter);\n  //  parent.removeChild(overlayOuter);\n  //};\n\n  //var overlay_to_gif = function(overlayInner) {\n  //  // We get overlayInner because that's what the event handler is on.\n  //  return overlayInner.previousSibling;\n  //};\n\n  insertCSS(bookmarkletCSS);\n\n  // XXX: In retrospect, this behavior is more confusing than useful.\n  //if (gifs.length === 1) {\n  //  setTimeout(function() { playGIF(gifs[0]); }, 0);\n  //  return;\n  //}\n\n  gifs.forEach(mkOverlay);\n};\n\n// So here we take advantage of the fact that we didn't tell Closure that we're\n// exporting this function, which means we can do \"var b = ...; b();\" and it'll\n// handle it correctly.\n// This used to be even more convoluted.\n\n// BEGIN_NON_BOOKMARKLET_CODE\n/*\n// END_NON_BOOKMARKLET_CODE\nbookmarklet();\n// BEGIN_NON_BOOKMARKLET_CODE\n*/\n// END_NON_BOOKMARKLET_CODE\n"]}