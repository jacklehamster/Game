{"version":3,"sources":["../../../lib/dobuki/loader.js"],"names":["global","factory","exports","module","define","amd","DOK","core","index","imageQueue","loadLimit","loading","loadingBar","visualProgress","onLoadCallback","loaded","loadTotal","requireScripts","logScript","setOnLoad","onLoad","document","body","removeChild","getLoadingBar","loadImage","url","image","Image","onload","event","call","checkLoad","crossOrigin","push","loadFile","loadAsync","result","length","src","getLoadingProgress","refreshLoadingBar","ctx","getContext","actualProgress","Math","max","removeLoop","fillRect","width","height","setTimeout","createElement","id","round","innerWidth","style","left","top","innerHeight","position","backgroundColor","border","fillStyle","addLoop","appendChild","destroyEverything","initializeLoader","combineMethods","addEventListener"],"mappings":"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","file":"loader.js","sourcesContent":["(function (global, factory) {\n    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n        typeof define === 'function' && define.amd ? define(['exports'], factory) :\n            (factory((global.DOK = global.DOK || {})));\n}(this, (function (core) { 'use strict';\n\n    var index = 0;\n    var imageQueue = [];\n    var loadLimit = 3;\n    var loading = 0;\n    var loadingBar = null;\n    var visualProgress = 0;\n    var onLoadCallback = null;\n    var loaded = 0;\n    var loadTotal = 0;\n\n    /**\n     *  HEADER\n     */\n    core.requireScripts([\n        'setup.js',\n        'loop.js',\n    ]);\n    core.logScript();\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n    function setOnLoad(onLoad) {\n        onLoadCallback = onLoad;\n        document.body.removeChild(core.getLoadingBar());\n    }\n\n    function loadImage(url,onLoad) {\n        var image = new Image();\n        image.onload = function(event) {\n            onLoad.call(image,event);\n            loading--;\n            loaded++;\n            checkLoad();\n        };\n        image.crossOrigin = '';\n        imageQueue.push({\n            image: image,\n            url: url,\n        });\n        loadTotal++;\n        checkLoad();\n        return image;\n    }\n\n    function loadFile(url,onLoad) {\n        loadTotal++;\n        core.loadAsync(url, function(result) {\n            loaded++;\n            onLoad(result);\n        });\n    }\n\n    function checkLoad() {\n        while(index<imageQueue.length && loading<loadLimit) {\n            imageQueue[index].image.src = imageQueue[index].url;\n            index++;\n            loading++;\n        }\n        if(index===imageQueue.length) {\n            index = 0;\n            imageQueue.length = 0;\n            loaded = 0;\n            loadTotal = 0;\n        }\n    }\n\n    function getLoadingProgress() {\n        return !loadTotal ? 1 : loaded / loadTotal;\n    }\n\n    function refreshLoadingBar() {\n        if(loadingBar) {\n            var ctx = loadingBar.getContext(\"2d\");\n            var actualProgress = getLoadingProgress();\n            visualProgress = Math.max(0,visualProgress + (actualProgress-visualProgress)/10);\n            if(actualProgress>=1) {\n                visualProgress = 1;\n                core.removeLoop(refreshLoadingBar);\n            }\n            ctx.fillRect(10,10,(loadingBar.width-20)*visualProgress,loadingBar.height-20);\n\n            if(actualProgress>=1) {\n                if(onLoadCallback) {\n                    setTimeout(onLoadCallback,100);\n                }\n            }\n        }\n    }\n\n    function getLoadingBar() {\n        if(!loadingBar) {\n            loadingBar = document.createElement(\"canvas\");\n            loadingBar.id = \"loading\";\n            loadingBar.width = Math.round((innerWidth*2)*2/3);\n            loadingBar.height = 50;\n            loadingBar.style.left = (innerWidth/2-loadingBar.width/4)+\"px\";\n            loadingBar.style.top = (innerHeight/2-loadingBar.height/4)+\"px\";\n            loadingBar.style.width = (loadingBar.width/2) + \"px\";\n            loadingBar.style.height = (loadingBar.height/2) + \"px\";\n            loadingBar.style.position = \"absolute\";\n            loadingBar.style.backgroundColor = \"white\";\n            loadingBar.style.border = \"10px double #00DDDD\";\n            var ctx = loadingBar.getContext(\"2d\");\n            ctx.fillStyle=\"#0066aa\";\n            core.addLoop(refreshLoadingBar);\n        }\n        document.body.appendChild(loadingBar);\n        return loadingBar;\n    }\n\n    function destroyEverything() {\n        imageQueue = [];\n    }\n\n    function initializeLoader() {\n        DOK.getLoadingBar();\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    core.loadImage = loadImage;\n    core.loadFile = loadFile;\n    core.getLoadingProgress = getLoadingProgress;\n    core.getLoadingBar = getLoadingBar;\n    core.setOnLoad = setOnLoad;\n    core.destroyEverything = core.combineMethods(destroyEverything, core.destroyEverything);\n\n    /**\n     *   PROCESSES\n     */\n    document.addEventListener(\"DOMContentLoaded\",initializeLoader);\n\n})));"]}