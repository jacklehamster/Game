{"version":3,"sources":["../../../lib/dobuki/utils.js"],"names":["global","factory","exports","module","define","amd","DOK","core","definePrototypes","String","prototype","trim","replace","window","requestAnimationFrame","setupRequestAnimationFrame","Float32Array","fill","fill_compat","Uint32Array","Array","getFrame","index","length","Number","value","start","end","i","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame","requestAnimationFrame_compat","timeout","time","callback","setTimeout","timeoutCallback","clearTimeout","dt","Date","now","loadAsyncHelper","src","result","binary","method","data","loadAsync","undefined","apply","isArray","xhr","XMLHttpRequest","overrideMimeType","open","addEventListener","e","readyState","status","responseText","handleError","send","Roundabout","x","y","left","right","top","bottom","direction","point","reset","current","next","addLinkToHeadTag","rel","href","link","document","createElement","setAttribute","head","appendChild","setupQuaternionArrays","groundQuaternionArray","THREE","Quaternion","setFromAxisAngle","Vector3","Math","PI","toArray","southQuaternionArray","northQuaternionArray","westQuaternionArray","eastQuaternionArray","ceilingQuaternionArray","requireScripts","logScript","title","str","object","JSON","parse","icon"],"mappings":"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","file":"utils.js","sourcesContent":["(function (global, factory) {\n \ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n \ttypeof define === 'function' && define.amd ? define(['exports'], factory) :\n \t(factory((global.DOK = global.DOK || {})));\n }(this, (function (core) { 'use strict';\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n    function definePrototypes() {\n        if(typeof(String.prototype.trim) === \"undefined\") {\n            String.prototype.trim = function() {\n                return String(this).replace(/^\\s+|\\s+$/g, '');\n            };\n        }\n\n        if ( !window.requestAnimationFrame ) {\n            setupRequestAnimationFrame();\n        }\n\n        if (typeof(Float32Array.prototype.fill) === 'undefined') {\n            Float32Array.prototype.fill = fill_compat;\n        }\n\n        if (typeof(Uint32Array.prototype.fill) === 'undefined') {\n            Uint32Array.prototype.fill = fill_compat;\n        }\n\n        Array.prototype.getFrame = function (index) {\n            index = index|0;\n            return this[index % this.length];\n        };\n        Number.prototype.getFrame = function () {\n            return this;\n        }\n\n    }\n\n    function fill_compat(value,start,end) {\n        start = start||0;\n        end = end||this.length;\n        for(var i=start;i<end;i++) {\n            this[i] = value;\n        }\n        return this;\n    }\n\n    function setupRequestAnimationFrame() {\n        window.requestAnimationFrame = ( function() {\n            return window.webkitRequestAnimationFrame ||\n                window.mozRequestAnimationFrame ||\n                window.oRequestAnimationFrame ||\n                window.msRequestAnimationFrame ||\n                requestAnimationFrame_compat;\n\n        } )();\n\n        var timeout, time = 0;\n        function requestAnimationFrame_compat( callback) {\n            timeout = setTimeout( timeoutCallback, 1000 / 60 , callback);\n        }\n\n        function timeoutCallback(callback) {\n            clearTimeout(timeout);\n            var dt = Date.now() - time;\n            callback(dt);\n            time = Date.now();\n        }\n    }\n\n    function loadAsyncHelper(src, result, index, callback, binary, method, data) {\n        loadAsync(src, function(value) {\n            result[index] = value;\n            for(var i=0; i<result.length; i++) {\n                if(result[i]===undefined) {\n                    return;\n                }\n            }\n            callback.apply(null, result);\n        }, binary, method, data);\n    }\n\n    function loadAsync(src, callback, binary, method, data) {\n        if(Array.isArray(src)) {\n            var result = new Array(src.length);\n            for(var i=0; i<src.length; i++) {\n                loadAsyncHelper(src[i], result, i, callback);\n            }\n\n        } else {\n            var xhr = new XMLHttpRequest();\n            xhr.overrideMimeType(binary ? \"text/plain; charset=x-user-defined\" : \"text/plain; charset=UTF-8\");\n            xhr.open(method?method:\"GET\", src, true);\n            xhr.addEventListener('load',\n                function (e) {\n                    if (xhr.readyState === 4) {\n                        if (xhr.status === 200) {\n                            callback(xhr.responseText);\n                        } else {\n                            core.handleError(xhr.responseText);\n                        }\n                    }\n                }\n            );\n            xhr.addEventListener('error',\n                function (e) {\n                    core.handleError(e);\n                }\n            );\n            xhr.send(data);\n        }\n    }\n\n    //      C\n    //     748\n    //    B3019\n    //     625\n    //      A\n\n\n    function Roundabout() {\n        this.x = 0;\n        this.y = 0;\n        this.left = -1;\n        this.right = 1;\n        this.top = -1;\n        this.bottom = 1;\n        this.direction = 0; //  0-right, 1-bottom, 2-left, 3-up\n\n        var point = [0,0];\n\n        this.reset = function() {\n            this.x = 0;\n            this.y = 0;\n            this.left = -1;\n            this.right = 1;\n            this.top = -1;\n            this.bottom = 1;\n            this.direction = 0; //  0-right, 1-bottom, 2-left, 3-up\n        };\n\n        this.current = function() {\n            point[0] = this.x;\n            point[1] = this.y;\n            return point;\n        };\n\n        this.next = function () {\n            var point = this.current();\n            switch(this.direction) {\n                case 0:\n                    this.x++;\n                    if(this.x >= this.right) {\n                        this.right++;\n                        this.direction = (this.direction+1)%4;  //  change dir\n                    }\n                    break;\n                case 1:\n                    this.y++;\n                    if(this.y >= this.bottom) {\n                        this.bottom++;\n                        this.direction = (this.direction+1)%4;\n                    }\n                    break;\n                case 2:\n                    this.x--;\n                    if(this.x <= this.left) {\n                        this.left--;\n                        this.direction = (this.direction+1)%4;  //  change dir\n                    }\n                    break;\n                case 3:\n                    this.y--;\n                    if(this.y <= this.top) {\n                        this.top--;\n                        this.direction = (this.direction+1)%4;  //  change dir\n                    }\n                    break;\n            }\n            return point;\n        }\n    }\n\n    function addLinkToHeadTag(rel, href) {\n        var link = document.createElement(\"link\");\n        link.setAttribute(\"rel\", rel);\n        link.href = href;\n        document.head.appendChild(link);\n    }\n\n    function setupQuaternionArrays() {\n        core.groundQuaternionArray =  new THREE.Quaternion().setFromAxisAngle(\n            new THREE.Vector3(1,0,0), -Math.PI/2\n        ).toArray(new Float32Array(4));\n        core.southQuaternionArray =  new THREE.Quaternion().toArray(new Float32Array(4));\n        core.northQuaternionArray =  new THREE.Quaternion().setFromAxisAngle(\n            new THREE.Vector3(0,1,0), -Math.PI\n        ).toArray(new Float32Array(4));\n        core.westQuaternionArray =  new THREE.Quaternion().setFromAxisAngle(\n            new THREE.Vector3(0,1,0), -Math.PI/2\n        ).toArray(new Float32Array(4));\n        core.eastQuaternionArray =  new THREE.Quaternion().setFromAxisAngle(\n            new THREE.Vector3(0,1,0), Math.PI/2\n        ).toArray(new Float32Array(4));\n        core.ceilingQuaternionArray = new THREE.Quaternion().setFromAxisAngle(\n            new THREE.Vector3(1,0,0), Math.PI/2\n        ).toArray(new Float32Array(4));\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    core.loadAsync = loadAsync;\n    core.Roundabout = Roundabout;\n   \n    /**\n     *   PROCESSES\n     */\n    core.requireScripts(['setup.js']);\n    core.logScript();\n    core.title = \"\";\n    definePrototypes();\n    setupQuaternionArrays();\n\n    loadAsync(\"package.json\", function(str) {\n        try {\n            var object = JSON.parse(str);\n            var icon = object.window.icon || 'lib/dobuki/images/logo.ico';\n            document.title = core.title = object.window.title || 'Dobuki Game';\n            addLinkToHeadTag(\"shortcut icon\", icon);\n            addLinkToHeadTag(\"apple-touch-icon\", object.window['apple-touch-icon'] || icon);\n        } catch(e) {\n        }\n    });\n\n })));\n"]}