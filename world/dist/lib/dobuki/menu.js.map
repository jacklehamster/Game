{"version":3,"sources":["../../../lib/dobuki/menu.js"],"names":["global","factory","exports","module","define","amd","DOK","core","menus","activeMenu","requireScripts","logScript","getMenu","menu","id","div","d","document","createElement","innerHTML","style","display","position","border","boxShadow","backgroundColor","width","height","color","textAlign","fontFamily","fontSize","top","appendChild","arrow","src","left","disp","pos","x","y","arrowLooper","loop","getActiveMenu","selection","newDisp","Math","round","sin","time","maxLength","i","list","length","p","textContent","max","body","clearListeners","removeEventListener","handleKey","addListeners","addEventListener","customEvent","type","detail","evt","createEvent","initCustomEvent","e","target","dispatchEvent","keyCode","preventDefault","showMenu","trigger","menuStack","push","triggerMenu","hideMenu","shown","pop","toggleMenu","refreshMenus","destroyEverything","combineMethods","window","dx","dy","act","cancel","select","action"],"mappings":"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","file":"menu.js","sourcesContent":["(function (global, factory) {\n \ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n \ttypeof define === 'function' && define.amd ? define(['exports'], factory) :\n \t(factory((global.DOK = global.DOK || {})));\n }(this, (function (core) { 'use strict';\n    \n    var menus = {};\n    var activeMenu;\n    \n    /**\n     *  HEADER\n     */   \n    core.requireScripts([\n        'setup.js',\n    ]);\n    core.logScript();\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */   \n    function getMenu(menu) {\n        menus[menu.id] = menu;    \n        var div = menu.div;\n        var d;\n        if(!div) {\n            div = document.createElement(\"div\");\n            menu.div = div;\n            div.id = menu.id;\n            div.innerHTML = \"\";\n            div.style.display = \"none\";\n            div.style.position = \"absolute\";\n            div.style.border = \"10px double #DDDDDD\";\n        //    div.style.borderImage = \"url(frame.png) round\";\n//            div.style.borderImageSlice = \"30%\";\n//            div.style.borderImageWidth = \"40px\";\n            div.style.boxShadow = \"10px 10px rgba(0, 0, 0, 0.5)\";\n            d = document.createElement(\"div\");\n            menu.d = d;\n            d.style.position = \"absolute\";\n            d.style.backgroundColor = \"black\";\n            d.style.width = \"100%\";\n            d.style.height= \"100%\";\n            d.style.color = \"white\";\n            d.style.textAlign = \"center\";\n            d.style.fontFamily = 'Courier';\n            d.style.fontSize = \"28px\";\n            d.style.top = \"0px\";\n            div.appendChild(d);\n            var arrow = document.createElement(\"img\");\n            menu.arrow = arrow;\n            arrow.src = \"lib/dobuki/images/arrow.png\";\n            arrow.style.position = \"absolute\";\n            arrow.style.left = \"10px\";\n            arrow.style.top = \"15px\";\n            arrow.style.display = \"none\";\n            var disp = null;\n            var pos = {x:0,y:0};\n            var arrowLooper = {\n                id:menu.id + \".arrow\",\n                loop:function() {\n                    if(getActiveMenu() !== menu) {\n                        arrow.style.display = disp = \"none\";\n                        menu.selection = -1;\n                        return false;\n                    }\n                    var newDisp = menu.selection>=0?\"\":\"none\";\n                    if(newDisp !== disp) {\n                        disp = newDisp;\n                        arrow.style.display = disp;\n                    }\n                    var left = Math.round(Math.sin(core.time/100)*6+10);\n                    if(left!=pos.x) {\n                        pos.x = left;\n                        arrow.style.left = pos.x + \"px\";\n                    }\n                    var top = Math.round(10 + menu.selection * 36);\n                    if(top!=pos.y) {\n                        pos.y = top;\n                        arrow.style.top = pos.y + \"px\";\n                    }\n                }\n            };\n            menu.arrowLooper = arrowLooper;\n        }\n        menu.selection = 0;\n        menu.d.innerHTML = \"\";\n        var maxLength = 0;\n        for(var i=0;i<menu.list.length;i++) {\n            var p = document.createElement(\"p\");\n            p.textContent = menu.list[i];\n            menu.d.appendChild(p);\n            maxLength = Math.max((menu.list[i]+\"\").length,maxLength);\n        }\n        menu.d.appendChild(menu.arrow);\n        div.style.width = (17*maxLength + 74)+\"px\";\n        div.style.height = menu.list.length*36 + \"px\";\n        //console.log(maxLength,menu.list.length,div);\n        document.body.appendChild(div);\n        var position = menu.position;\n        div.style.left = position[0] + \"px\";\n        div.style.top = position[1] + \"px\";\n        return div;    \n    }\n\n    function clearListeners() {\n        document.removeEventListener(\"keydown\", handleKey);\n    }\n\n    function addListeners() {\n        document.addEventListener(\"keydown\", handleKey);\n    }\n\n    function customEvent(type, detail) {\n        var evt = document.createEvent(\"CustomEvent\");\n        evt.initCustomEvent(type, false, false,detail||{});\n        return evt;\n    }\n\n    function handleKey(e) {\n        if(e.target===document.body) {\n            if(e.type === \"keydown\") {\n                document.dispatchEvent(customEvent(\"firstPress\",{\n                     keyCode: e.keyCode\n                 }));\n            }\n            e.preventDefault();\n        }\n    }\n\n    function showMenu(menu, trigger) {\n        if(getActiveMenu() && trigger) {\n            menuStack.push(getActiveMenu());\n        }\n        getMenu(menu).style.display = \"\";\n        if(trigger) {\n            triggerMenu(menu);\n        }\n        clearListeners();\n        addListeners();\n    }\n    \n    function hideMenu(menu) {\n        getMenu(menu).style.display = \"none\";\n        menu.shown = false;\n        if(menuStack.length) {\n            showMenu(menuStack.pop(), true);\n        }\n        clearListeners();\n    }\n\n    function toggleMenu(menu) {\n        if(menu.shown) {\n            hideMenu(menu);\n        } else {\n            showMenu(menu);\n        }\n    }\n\n    var menuStack = [];\n    \n    function triggerMenu(menu) {\n        activeMenu = menu;\n        menu.shown = core.time;\n        core.trigger(menu.arrowLooper);\n    }\n    \n    function getActiveMenu() {\n        return activeMenu && activeMenu.shown ? activeMenu : null;\n    }\n    \n    function refreshMenus() {\n        for(var i in menus) {\n            var menu = menus[i];\n            getMenu(menu);\n        }\n    }\n         \n    function destroyEverything() {\n    }\n   \n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    core.showMenu = showMenu;\n    core.hideMenu = hideMenu;\n    core.toggleMenu = toggleMenu;\n    core.getActiveMenu = getActiveMenu;\n    core.refreshMenus = refreshMenus;\n    core.destroyEverything = core.combineMethods(destroyEverything, core.destroyEverything);\n\n    /**\n     *   PROCESSES\n     */\n    window.addEventListener(\"resize\", refreshMenus);\n\n    document.addEventListener(\"firstPress\",\n        function(e) {\n            var dx = 0, dy=0, act = false, cancel;\n            switch(e.detail.keyCode) {\n                case 27:\n                    cancel = true;\n                    break;\n                case 32:\n                    act = true;\n                    break;\n                case 87: case 38:\n                dy++;\n                break;\n                case 83: case 40:\n                dy--;\n                break;\n                case 65: case 37:\n                dx--;\n                break;\n                case 68: case 39:\n                dx++;\n                break;\n            }\n            var activeMenu = core.getActiveMenu();\n            if(activeMenu) {\n                if(dy) {\n                    activeMenu.selection = (activeMenu.selection-dy+activeMenu.list.length) % activeMenu.list.length;\n                    if(activeMenu.select) {\n                        activeMenu.select(activeMenu.selection);\n                    }\n                }\n                if(act) {\n                    if(activeMenu.action) {\n                        activeMenu.action(activeMenu.selection);\n                    }\n                }\n                if(cancel) {\n                    if(activeMenu.cancel) {\n                        activeMenu.cancel();\n                    }\n                }\n            }\n        }\n    );\n\n })));"]}