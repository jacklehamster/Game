<!DOCTYPE html>
<html>
<head>
    <title>Loading...</title>
    <meta name="google" content="notranslate"/>
    <meta charset="UTF-8"/>
    <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no,width=device-width, initial-scale=1.0,minimum-scale=1.0"/>
    <meta name="theme-color" content="#d5f97a" />
    <link rel="stylesheet" type="text/css" href="lib/dobuki/style/style.css">
</head>
<body>
<span id="fps" style="display:block; position:absolute; color:silver; top:0; left:0"></span>


<script src="lib/dobuki/setup.js"></script>
<script src="lib/md5/md5.min.js"></script>
<script src="lib/threejs/three.min.js"></script>
<script src="lib/jsgif/gif.js"></script>
<script src="lib/dobuki/objectpool.js"></script>
<script src="lib/dobuki/turbosort.js"></script>
<script src="lib/dobuki/utils.js"></script>
<script src="lib/dobuki/gifhandler.js"></script>
<script src="lib/dobuki/audio.js"></script>
<script src="lib/dobuki/packer.js"></script>
<script src="lib/dobuki/menu.js"></script>
<script src="lib/dobuki/loop.js"></script>
<script src="lib/dobuki/triggerloop.js"></script>
<script src="lib/dobuki/imageloader.js"></script>
<script src="lib/dobuki/camera.js"></script>
<script src="lib/dobuki/spritesheet.js"></script>
<script src="lib/dobuki/spriterenderer.js"></script>
<script src="lib/dobuki/collection.js"></script>
<script src="lib/dobuki/keyboard.js"></script>
<script src="lib/dobuki/mouse.js"></script>
<script src="lib/dobuki/editcontrol.js"></script>

<script>
    var debug = {
        fps: location.search.indexOf("fps")>=0,
    };

    document.getElementById("fps").style.display = debug.fps ? "" : "none";

    var renderer = new THREE.WebGLRenderer({ antialias: true });
    var scene = new THREE.Scene();
    renderer.setClearColor (0, 1);

    renderer.render(scene,DOK.getCamera());
    window.addEventListener("resize",function() {
        renderer.setSize( innerWidth, innerHeight );
    });
    renderer.sortObjects = false;

    renderer.setSize( innerWidth, innerHeight );
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setClearColor (0xffffff, 1);
    document.body.appendChild( renderer.domElement );

    DOK.addControlBall();
    DOK.addControlBox();

    var images = {
        squid: [
            "lib/dobuki/images/squid.png|0,0,32,32",
            "lib/dobuki/images/squid.png|32,0,32,32",
            "lib/dobuki/images/squid.png|0,32,32,32",
            "lib/dobuki/images/squid.png|32,32,32,32",
        ],
        floor: "lib/dobuki/images/wood.png|border",
        water: "lib/dobuki/images/water.gif",
    };
    DOK.preLoad(images);

    var spriteRenderer = new DOK.SpriteRenderer();
    scene.add(spriteRenderer.mesh);


    var range = 20;
    renderer.setClearColor (0xffffff, 1);

    function random(x, y, n) {
        var r = Math.PI * ((x*13) ^ y*11 ^ n);
        return r - Math.floor(r)
    }

    var cells = [];
    var collection = new DOK.Collection(
        {
            type: "grid",
            get x() {
                return -Math.floor(range/2 - camera.position.x/256);
            },
            get y() {
                return -Math.floor(range/2 - camera.position.z/256);
            },
            width: range,
            height: range,
        },
        function(x,y) {
            var frame = Math.floor(DOK.time/100);

            var hasWater = x%10===5 || y%20===10;
            var hasCell = random(x,y,0)<.8 && random((y/3)|0,(x/3)|0,1) < .8;
            var dx = x - camera.position.x/256;
            var dz = y - camera.position.z/256;
            var distSq = Math.sqrt(dx*dx+dz*dz);

            if(hasWater) {
                cells.length = 0;
                cells.push(DOK.create(DOK.SpriteObject).init(
                    x*256,-64,y*256,
                    256,256,
                    DOK.groundQuaternionArray,
                    (distSq+1)/2,//c===0 ? 1:1.5,
                    DOK.spritesheet.water,
                    0,0,0
                ));
                return cells;
            } else if(hasCell) {
                cells.length = 0;
                cells.push(DOK.create(DOK.SpriteObject).init(
                    x*256,-64,y*256,
                    256,256,
                    DOK.groundQuaternionArray,
                    (distSq+1)/2,//c===0 ? 1:1.5,
                    DOK.spritesheet.floor,
                    0,0,0
                ));
                return cells;
            } else {
                cells.length = 0;
                cells.push(DOK.create(DOK.SpriteObject).init(
                    x*256,-64+128,y*256+128,
                    256,256,
                    DOK.southQuaternionArray,
                    (distSq+1)/2,//c===0 ? 1:1.5,
                    DOK.spritesheet.floor,
                    0,0,0
                ));
                cells.push(DOK.create(DOK.SpriteObject).init(
                    x*256,-64+128,y*256-128,
                    256,256,
                    DOK.northQuaternionArray,
                    (distSq+1)/2,//c===0 ? 1:1.5,
                    DOK.spritesheet.floor,
                    0,0,0
                ));
                cells.push(DOK.create(DOK.SpriteObject).init(
                    x*256-128,-64+128,y*256,
                    256,256,
                    DOK.westQuaternionArray,
                    (distSq+1)/2,//c===0 ? 1:1.5,
                    DOK.spritesheet.floor,
                    0,0,0
                ));
                cells.push(DOK.create(DOK.SpriteObject).init(
                    x*256+128,-64+128,y*256,
                    256,256,
                    DOK.eastQuaternionArray,
                    (distSq+1)/2,//c===0 ? 1:1.5,
                    DOK.spritesheet.floor,
                    0,0,0
                ));
                return cells;
            }
        }
    );

    function initialize() {
        DOK.getLoadingBar();
        DOK.setOnLoad(gameLoaded);
    }

    function gameLoaded() {
        document.body.removeChild(DOK.getLoadingBar());
        renderer.setClearColor (0xffffff, 1);
        renderer.render(scene,DOK.getCamera());
        startGame();
    }

    var camera = DOK.getCamera();
    var mz = 0, rot = 0, rotA = 0, buttonDown = false;
    DOK.setOnTouch(
        function(dx,dy,down) {
            if(dx!==null) {
                rot = THREE.Math.clamp(rot + dx/200, -10, 10);
            }
            if(dy!==null) {
                mz = THREE.Math.clamp(mz - dy/2, -50, 20);
            }
            buttonDown = down;
        }
    );

    DOK.addLoop(function() {
        var mov = DOK.getMove();
        rot = THREE.Math.clamp(rot - mov[0]*.05, -10, 10);
        mz = THREE.Math.clamp(mz - mov[1], -50, 20);
    });


    /*    var geometry = new THREE.SphereGeometry(3, 50, 50, 0, Math.PI * 2, 0, Math.PI * 2);
        var material = new THREE.MeshNormalMaterial();
        var egg = new THREE.Mesh(geometry, material);
        egg.position.set(0,0,0);
        egg.geometry.scale(8,10,8);
        scene.add(egg);
    */

    var forwardVector = new THREE.Vector3(0,1,0);
    var moveVector = new THREE.Vector3(0,0,0);

    function startGame() {
        DOK.fps = 45;
        var frame = 0;
        DOK.addLoop(function() {
            frame++;
            if(debug.fps && frame%10===0)
                document.getElementById("fps").textContent = DOK.fps + " fps";
        });
        DOK.addLoop(function() {
            var camera = DOK.getCamera();
            if(Math.abs(mz)>0) {
                moveVector.copy(DOK.getCameraQuaternionData().forwardMovement);
                moveVector.setLength(mz);
                camera.position.add(moveVector);
                mz *= .9;
            } else {
                mz = 0;
            }

            if(Math.abs(rot)>.01) {
                rotA += rot;
                rot *= .5;
            }
            camera.quaternion.setFromAxisAngle(forwardVector, rotA);
        });
        DOK.addLoop(function() {
            spriteRenderer.display(collection);
            spriteRenderer.updateGraphics();
            renderer.render(scene, camera);
        });
    }

    document.addEventListener("DOMContentLoaded",initialize);
</script>
</body>
<div style="position:absolute; top:0; left:0; color:black" id="log"></div>

</html>