function clearCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height),makeBackground()}function nextScene(){loop=nop,preNext(),preNext=nop,sceneIndex=Math.min(scenes.length-1,sceneIndex+1),scenes[sceneIndex]()}function startOver(){name="",slots=[],loop=nop,preNext(),preNext=nop,sceneIndex=0,scenes[sceneIndex]()}function makeBox(){for(var i=0;i<4;i++)box[i]+=(arguments[i]-box[i])/8}function makeHero(){for(var i=0;i<4;i++)hero[i+5]+=(arguments[i]-hero[i+5])/8}function makeText(text,start){var size=Math.floor((time-start)/100);return text.slice(0,Math.max(0,Math.min(size,text.length)))}function enterText(text,start){return text+(time>start&&(time-start)%1200<900?"_":"")}function makeBackground(){ctx.fillStyle=grd,ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#000000"}function looper(t){time=t,loop(),requestAnimationFrame(looper)}var canvas=document.getElementsByTagName("canvas")[0],ctx=canvas.getContext("2d"),name="",time=0,nop=function(){},loop=nop,preNext=nop,grd=ctx.createRadialGradient(canvas.width/2-100,canvas.height/2+20,20,canvas.width/2+100,canvas.height/2-20,300);grd.addColorStop(0,"#D0D0D0"),grd.addColorStop(1,"#EEEEEE");var slots=[],hero=[null,0,0,0,0,0,0,0,0],box=[200,200,500,80],sceneIndex=0,promptImage=null,scenes=[function(){function cancel(e){return e=e||event,e.preventDefault(),!1}var start=time+1e3;makeBox(0,0,canvas.width,canvas.height),loop=function(){clearCanvas(),ctx.font="30px Comic",ctx.fillText(makeText("Welcome... what is your name?",start),260,150),time-start>4e3&&(makeBox(200,200,500,80),ctx.strokeRect.apply(ctx,box)),ctx.font="60px Comic",ctx.fillText(enterText(name,start+4500),250,260)};var f;document.addEventListener("keydown",f=function(e){if(e=e||event,13===e.keyCode)nextScene();else if(8===e.keyCode)name=name.slice(0,name.length-1);else{var key=e.key||String.fromCharCode("0x"+e.keyIdentifier.split("U+")[1]);name+=key.toUpperCase(),name.length>10&&(name=name.slice(1))}e.preventDefault()}),document.addEventListener("dragover",cancel),document.addEventListener("dragenter",cancel),document.addEventListener("dragleave",cancel),document.addEventListener("drop",cancel),preNext=function(){document.removeEventListener("keydown",f),document.removeEventListener("dragover",cancel),document.removeEventListener("dragenter",cancel),document.removeEventListener("dragleave",cancel),document.removeEventListener("drop",cancel)}},promptImage=function(){function cancel(e){return e=e||event,"dragenter"==e.type?dragOver=1:"dragleave"==e.type&&(dragOver=0),e.preventDefault(),!1}var start=time,message=[null,["Hello "+name+". May I see you?","Please drop a picture in the box below."],["You look great "+name+"! Let's keep going.","What do you like? Please drop a picture below"],["How about something you dislike?","Can you drop that picture below?"],["Finally, can you drop one more picture?","Just choose something random."]],dropped=0,mx=0,my=0,img=new Image;slots[sceneIndex-1]=img;var dragOver=0;img.addEventListener("load",function(e){hero[5]=mx-img.naturalWidth/2,hero[6]=my-img.naturalHeight/2,hero[7]=img.naturalWidth,hero[8]=img.naturalHeight}),hero[0]=img,loop=function(){clearCanvas(),ctx.font="25px Comic",ctx.fillText(makeText(message[sceneIndex][0],start),290,30),ctx.fillText(makeText(message[sceneIndex][1],start+4500),255,60);var max=Math.max(img.naturalWidth,img.naturalHeight);dropped&&time-dropped>600&&img.naturalWidth?makeBox(400,175,100*img.naturalWidth/max,100*img.naturalHeight/max):makeBox(300+dragOver*Math.sin(time/30)*20,75+dragOver*Math.sin(time/30)*20,300-2*dragOver*Math.sin(time/30)*20,300-2*dragOver*Math.sin(time/30)*20),ctx.strokeRect.apply(ctx,box.map(Math.round)),hero[3]=img.naturalWidth,hero[4]=img.naturalHeight,makeHero(400,175,100*img.naturalWidth/max,100*img.naturalHeight/max),ctx.drawImage.apply(ctx,hero),dropped&&time-dropped>1e3&&nextScene()},preNext=function(){document.removeEventListener("dragover",cancel),document.removeEventListener("dragenter",cancel),document.removeEventListener("dragleave",cancel),document.removeEventListener("drop",f)};var f;document.addEventListener("dragover",cancel),document.addEventListener("dragenter",cancel),document.addEventListener("dragleave",cancel),document.addEventListener("drop",f=function(e){e=e||event,dropped=time,dragOver=0,e.preventDefault&&e.preventDefault(),mx=e.pageX,my=e.pageY;var dt=e.dataTransfer,files=(dt.items,dt.files),file=files[0],reader=new FileReader;return reader.addEventListener("loadend",function(e){if(!("image/gif"!=file.type&&"image/jpeg"!=file.type&&"image/png"!=file.type||file.size>1e7)){this.result;img.src=this.result,reader=null}}),reader.readAsDataURL(file),!1})},promptImage,promptImage,promptImage,function(){function cancel(e){return e=e||event,e.preventDefault(),!1}var start=time;makeBox(0,0,canvas.width,canvas.height),document.addEventListener("dragover",cancel),document.addEventListener("dragenter",cancel),document.addEventListener("dragleave",cancel),document.addEventListener("drop",cancel),loop=function(){clearCanvas(),ctx.font="30px Comic",ctx.fillText(makeText("Let's go over this again",start),260,100),ctx.fillText(makeText("        is what "+name+" looks like.",start+4e3),260,150),ctx.fillText(makeText("        is something "+name+" is fond of.",start+8e3),260,200),ctx.fillText(makeText(".. not so much ",start+13e3),260,250),ctx.fillText(makeText("About            ... I just don't know what to say",start+17e3),260,300),ctx.fillText(makeText("Are you happy with your choices?",start+26e3),260,350),ctx.fillText(makeText("Press the  space bar  for YES, esc for NO.",start+31e3),260,400);for(var i=0;i<slots.length;i++)if(time-start>timings[i]){var scale=50/slots[i].naturalHeight;ctx.drawImage(slots[i],0,0,slots[i].naturalWidth,slots[i].naturalHeight,locations[i][0],locations[i][1],slots[i].naturalWidth*scale,slots[i].naturalHeight*scale)}time-start>33e3&&(makeBox(locations[4][0]+8*Math.sin(time/50),locations[4][1]+8*Math.sin(time/50),locations[4][2]+-2*Math.sin(time/50)*8,locations[4][3]+-2*Math.sin(time/50)*8),ctx.strokeRect.apply(ctx,box.map(Math.round)))};var f;document.addEventListener("keydown",f=function(e){e=e||event,time-start>33e3&&(32===e.keyCode?nextScene():27===e.keyCode&&startOver()),e.preventDefault()}),preNext=function(){document.removeEventListener("keydown",f),document.removeEventListener("dragover",cancel),document.removeEventListener("dragenter",cancel),document.removeEventListener("dragleave",cancel),document.removeEventListener("drop",cancel)}},function(){function cancel(e){return e=e||event,e.preventDefault(),!1}document.addEventListener("dragover",cancel),document.addEventListener("dragenter",cancel),document.addEventListener("dragleave",cancel),document.addEventListener("drop",cancel),loop=function(){clearCanvas();var scale=50/slots[0].naturalHeight;ctx.drawImage(slots[0],0,0,slots[0].naturalWidth,slots[0].naturalHeight,locations[0][0],locations[0][1],slots[0].naturalWidth*scale,slots[0].naturalHeight*scale),makeBox(0,400,900,2),ctx.strokeRect.apply(ctx,box.map(Math.round))}}],locations=[[250,110],[250,165],[445,215],[345,265],[375,374,125,40]],timings=[4e3,8e3,15e3,18e3];scenes[0](),looper(0);